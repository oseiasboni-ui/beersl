<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | BeerStylesLibrary</title>
    <link rel="stylesheet" href="css/variables.css">
    <link rel="stylesheet" href="css/styles.css">

    <!-- Cropper.js CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css">

    <style>
        body {
            margin: 0;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f8f9fa;
        }

        .admin-header {
            background: var(--color-bg-dark, #2c3e50);
            color: white;
            padding: 1.5rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .admin-header h1 {
            margin: 0;
            font-size: 1.5rem;
        }

        .admin-header .user-info {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .logout-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .logout-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .admin-container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 2rem;
        }

        .admin-actions {
            margin-bottom: 2rem;
        }

        .btn-primary {
            background: var(--color-primary, #e67e22);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary:hover {
            background: #d35400;
        }

        .beers-list {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .beers-list h2 {
            margin-top: 0;
            color: #2c3e50;
        }

        .beer-item {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            padding: 1rem;
            border-bottom: 1px solid #ecf0f1;
        }

        .beer-item:last-child {
            border-bottom: none;
        }

        .beer-image-preview {
            width: 80px;
            height: 80px;
            border-radius: 8px;
            object-fit: cover;
            background: #ecf0f1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
        }

        .beer-image-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 8px;
        }

        .beer-info {
            flex: 1;
        }

        .beer-info h3 {
            margin: 0 0 0.25rem 0;
            color: #2c3e50;
        }

        .beer-info p {
            margin: 0;
            color: #7f8c8d;
            font-size: 0.9rem;
        }

        .beer-actions {
            display: flex;
            gap: 0.5rem;
        }

        .btn-upload {
            background: var(--color-primary, #e67e22);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .btn-upload:hover {
            background: #d35400;
        }

        .file-input {
            display: none;
        }

        .upload-progress {
            display: none;
            margin-top: 0.5rem;
            color: #7f8c8d;
            font-size: 0.85rem;
        }

        .upload-progress.show {
            display: block;
        }

        .loading-state {
            text-align: center;
            padding: 3rem;
            color: #7f8c8d;
        }

        /* Crop Modal Styles */
        .crop-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 10000;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .crop-modal.active {
            display: flex;
        }

        .crop-container {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow: auto;
        }

        .crop-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .crop-header h3 {
            margin: 0;
            color: #2c3e50;
        }

        .crop-image-container {
            max-width: 100%;
            max-height: 400px;
            margin-bottom: 1.5rem;
        }

        .crop-image-container img {
            max-width: 100%;
        }

        .crop-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
        }

        .btn-cancel {
            background: #95a5a6;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            cursor: pointer;
        }

        .btn-crop {
            background: var(--color-primary, #e67e22);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            cursor: pointer;
        }
    </style>
</head>

<body>
    <div class="admin-header">
        <h1>üç∫ Admin Dashboard</h1>
        <div class="user-info">
            <span id="user-email">admin@beersl.com</span>
            <button class="logout-btn" id="logout-btn">Sair</button>
        </div>
    </div>

    <div class="admin-container">
        <div class="admin-actions">
            <a href="index.html" class="btn-primary">‚Üê Voltar ao Site</a>
        </div>

        <div class="beers-list">
            <h2>Gerenciar Fotos das Cervejas</h2>
            <div id="beers-container">
                <div class="loading-state">Carregando cervejas...</div>
            </div>
        </div>
    </div>

    <!-- Crop Modal -->
    <div class="crop-modal" id="crop-modal">
        <div class="crop-container">
            <div class="crop-header">
                <h3>Recortar Imagem (1:1)</h3>
                <button class="btn-cancel" id="close-crop">‚úï</button>
            </div>
            <div class="crop-image-container">
                <img id="crop-image" src="" alt="Crop">
            </div>
            <div class="crop-actions">
                <button class="btn-cancel" id="cancel-crop">Cancelar</button>
                <button class="btn-crop" id="confirm-crop">‚úì Recortar e Upload</button>
            </div>
        </div>
    </div>

    <!-- Cropper.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>

    <script type="module">
        import { requireAuth, getCurrentUser, logout } from './js/services/auth.js';
        import { fetchAllBeers } from './js/services/supabase.js';
        import { uploadAndUpdateBeer, validateImageFile } from './js/services/storage.js';
        
        let cropper = null;
        let currentBeerId = null;
        let currentFile = null;
        
        // Check authentication
        const authenticated = await requireAuth();
        if (!authenticated) {
            throw new Error('Not authenticated');
        }
        
        // Get current user
        const user = await getCurrentUser();
        if (user) {
            document.getElementById('user-email').textContent = user.email;
        }
        
        // Logout handler
        document.getElementById('logout-btn').addEventListener('click', async () => {
            try {
                await logout();
                window.location.href = 'admin.html';
            } catch (error) {
                console.error('Logout error:', error);
                alert('Erro ao fazer logout');
            }
        });
        
        // Crop modal handlers
        document.getElementById('close-crop').addEventListener('click', closeCropModal);
        document.getElementById('cancel-crop').addEventListener('click', closeCropModal);
        document.getElementById('confirm-crop').addEventListener('click', cropAndUpload);
        
        function closeCropModal() {
            document.getElementById('crop-modal').classList.remove('active');
            if (cropper) {
                cropper.destroy();
                cropper = null;
            }
            currentBeerId = null;
            currentFile = null;
        }
        
        function openCropModal(beerId, file) {
            currentBeerId = beerId;
            currentFile = file;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                const cropImage = document.getElementById('crop-image');
                cropImage.src = e.target.result;
                
                document.getElementById('crop-modal').classList.add('active');
                
                // Initialize cropper with 1:1 aspect ratio
                if (cropper) {
                    cropper.destroy();
                }
                
                cropper = new Cropper(cropImage, {
                    aspectRatio: 1 / 1, // Force square crop
                    viewMode: 1,
                    dragMode: 'move',
                    autoCropArea: 1,
                    restore: false,
                    guides: true,
                    center: true,
                    highlight: false,
                    cropBoxMovable: true,
                    cropBoxResizable: true,
                    toggleDragModeOnDblclick: false,
                });
            };
            reader.readAsDataURL(file);
        }
        
        async function cropAndUpload() {
            if (!cropper || !currentBeerId) return;
            
            const progress = document.getElementById(`progress-${currentBeerId}`);
            const button = document.querySelector(`button[data-beer-id="${currentBeerId}"]`);
            
            progress.classList.add('show');
            progress.textContent = 'Processando...';
            button.disabled = true;
            
            try {
                // Get cropped canvas
                const canvas = cropper.getCroppedCanvas({
                    width: 800,
                    height: 800,
                    imageSmoothingQuality: 'high'
                });
                
                // Convert canvas to blob
                canvas.toBlob(async (blob) => {
                    try {
                        // Create file from blob
                        const croppedFile = new File([blob], currentFile.name, {
                            type: 'image/jpeg',
                            lastModified: Date.now()
                        });
                        
                        progress.textContent = 'Enviando...';
                        
                        // Upload cropped image
                        const imageUrl = await uploadAndUpdateBeer(currentBeerId, croppedFile);
                        
                        progress.textContent = '‚úì Foto atualizada!';
                        progress.style.color = '#27ae60';
                        button.textContent = 'Trocar Foto';
                        button.disabled = false;
                        
                        closeCropModal();
                        
                        // Reload beers to show new image
                        setTimeout(() => {
                            loadBeers();
                        }, 1000);
                    } catch (error) {
                        console.error('Upload error:', error);
                        progress.textContent = `‚úó Erro: ${error.message}`;
                        progress.style.color = '#e74c3c';
                        button.disabled = false;
                        closeCropModal();
                    }
                }, 'image/jpeg', 0.95);
            } catch (error) {
                console.error('Crop error:', error);
                progress.textContent = `‚úó Erro ao processar imagem`;
                progress.style.color = '#e74c3c';
                button.disabled = false;
                closeCropModal();
            }
        }
        
        // Load beers
        async function loadBeers() {
            const container = document.getElementById('beers-container');
            
            try {
                const beers = await fetchAllBeers();
                
                if (beers.length === 0) {
                    container.innerHTML = '<p style="text-align:center; color:#7f8c8d;">Nenhuma cerveja encontrada</p>';
                    return;
                }
                
                container.innerHTML = '';
                
                beers.forEach(beer => {
                    const beerItem = createBeerItem(beer);
                    container.appendChild(beerItem);
                });
            } catch (error) {
                console.error('Error loading beers:', error);
                container.innerHTML = '<p style="text-align:center; color:#e74c3c;">Erro ao carregar cervejas</p>';
            }
        }
        
        // Create beer item element
        function createBeerItem(beer) {
            const item = document.createElement('div');
            item.className = 'beer-item';
            
            const hasImage = beer.image && !beer.image.includes('placeholder');
            const imageUrl = hasImage ? beer.image : null;
            
            item.innerHTML = `
                <div class="beer-image-preview">
                    ${imageUrl ? `<img src="${imageUrl}" alt="${beer.name}">` : 'üç∫'}
                </div>
                <div class="beer-info">
                    <h3>${beer.name}</h3>
                    <p>${beer.category || 'Sem categoria'} ‚Ä¢ ${beer.abv || 'N/A'}</p>
                    <div class="upload-progress" id="progress-${beer.id}"></div>
                </div>
                <div class="beer-actions">
                    <input type="file" class="file-input" id="file-${beer.id}" accept="image/*">
                    <button class="btn-upload" data-beer-id="${beer.id}">
                        ${hasImage ? 'Trocar Foto' : 'Upload Foto'}
                    </button>
                </div>
            `;
            
            const uploadBtn = item.querySelector('.btn-upload');
            const fileInput = item.querySelector('.file-input');
            
            uploadBtn.addEventListener('click', () => {
                fileInput.click();
            });
            
            fileInput.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                // Validate file
                const validation = validateImageFile(file);
                if (!validation.valid) {
                    alert(validation.error);
                    return;
                }
                
                // Open crop modal
                openCropModal(beer.id, file);
            });
            
            return item;
        }
        
        // Initial load
        loadBeers();
    </script>
</body>

</html>